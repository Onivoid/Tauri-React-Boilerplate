name: Release

on:
    push:
        tags:
            - "v*"

jobs:
    create-release:
        name: Create Release
        runs-on: ubuntu-latest
        outputs:
            release_id: ${{ steps.create-release.outputs.result }}
            release_upload_url: ${{ steps.create-release.outputs.upload_url }}

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Get version
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            - name: Create Release
              id: create-release
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data } = await github.rest.repos.createRelease({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        tag_name: `${{ steps.get_version.outputs.VERSION }}`,
                        name: `Release ${{ steps.get_version.outputs.VERSION }}`,
                        body: 'See CHANGELOG.md for details',
                        draft: true,
                        prerelease: false
                      })
                      return data.id

    build-and-upload:
        name: Build and Upload (${{ matrix.platform }})
        needs: create-release
        strategy:
            fail-fast: false
            matrix:
                platform: [macos-latest, ubuntu-latest, windows-latest]

        runs-on: ${{ matrix.platform }}

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Rust Cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: src-tauri

            - name: Install dependencies (Ubuntu)
              if: matrix.platform == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

            - name: Install frontend dependencies
              run: pnpm install --frozen-lockfile

            - name: Build Tauri app
              run: pnpm tauri build
              env:
                  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
                  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

            - name: Upload Release Assets
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      const releaseId = ${{ needs.create-release.outputs.release_id }};
                      const platform = '${{ matrix.platform }}';

                      let artifactPaths = [];

                      if (platform === 'macos-latest') {
                        artifactPaths = [
                          'src-tauri/target/release/bundle/dmg/*.dmg',
                          'src-tauri/target/release/bundle/macos/*.app.tar.gz'
                        ];
                      } else if (platform === 'ubuntu-latest') {
                        artifactPaths = [
                          'src-tauri/target/release/bundle/deb/*.deb',
                          'src-tauri/target/release/bundle/appimage/*.AppImage'
                        ];
                      } else if (platform === 'windows-latest') {
                        artifactPaths = [
                          'src-tauri/target/release/bundle/msi/*.msi',
                          'src-tauri/target/release/bundle/nsis/*.exe'
                        ];
                      }

                      const glob = require('@actions/glob');
                      for (const pattern of artifactPaths) {
                        const globber = await glob.create(pattern);
                        const files = await globber.glob();
                        
                        for (const file of files) {
                          const fileName = path.basename(file);
                          const fileContent = fs.readFileSync(file);
                          
                          await github.rest.repos.uploadReleaseAsset({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            release_id: releaseId,
                            name: fileName,
                            data: fileContent
                          });
                        }
                      }

    publish-release:
        name: Publish Release
        needs: [create-release, build-and-upload]
        runs-on: ubuntu-latest

        steps:
            - name: Publish Release
              uses: actions/github-script@v7
              with:
                  script: |
                      await github.rest.repos.updateRelease({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        release_id: ${{ needs.create-release.outputs.release_id }},
                        draft: false
                      })
