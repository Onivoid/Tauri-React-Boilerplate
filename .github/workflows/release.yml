name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build-and-release:
        name: Build (${{ matrix.platform.name }})
        strategy:
            fail-fast: false
            matrix:
                platform:
                    - name: macOS (universal)
                      os: macos-latest
                      rust-targets: aarch64-apple-darwin,x86_64-apple-darwin
                      args: "--target universal-apple-darwin"
                    - name: Linux (x86_64)
                      os: ubuntu-22.04
                      rust-targets: x86_64-unknown-linux-gnu
                      args: ""
                    - name: Windows (x86_64)
                      os: windows-latest
                      rust-targets: x86_64-pc-windows-msvc
                      args: ""

        runs-on: ${{ matrix.platform.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: lts/*
                  cache: pnpm

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.platform.rust-targets }}

            - name: Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: src-tauri

            - name: Install Linux dependencies
              if: matrix.platform.os == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

            - name: Install frontend dependencies
              run: pnpm install --frozen-lockfile

            - name: Build and release
              uses: tauri-apps/tauri-action@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
              with:
                  tagName: ${{ github.ref_name }}
                  releaseName: "Release ${{ github.ref_name }}"
                  releaseBody: "See CHANGELOG.md for details"
                  releaseDraft: false
                  prerelease: false
                  updaterJsonPreferNsis: true
                  uploadUpdaterSignatures: true
                  uploadUpdaterJson: true
                  args: ${{ matrix.platform.args }}
