name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build-and-release:
        name: Build (${{ matrix.platform.name }})
        strategy:
            fail-fast: false
            matrix:
                platform:
                    - name: macOS (universal)
                      os: macos-latest
                      rust-targets: aarch64-apple-darwin,x86_64-apple-darwin
                      args: "--target universal-apple-darwin"
                    - name: Linux (x86_64)
                      os: ubuntu-22.04
                      rust-targets: x86_64-unknown-linux-gnu
                      args: ""
                    - name: Windows (x86_64)
                      os: windows-latest
                      rust-targets: x86_64-pc-windows-msvc
                      args: ""

        runs-on: ${{ matrix.platform.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: lts/*
                  cache: pnpm

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.platform.rust-targets }}

            - name: Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: src-tauri

            - name: Install Linux dependencies
              if: matrix.platform.os == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

            - name: Install frontend dependencies
              run: pnpm install --frozen-lockfile

            - name: Build (macOS universal)
              if: matrix.platform.os == 'macos-latest'
              env:
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
              run: pnpm tauri build --target universal-apple-darwin

            - name: Build (Linux / Windows)
              if: matrix.platform.os != 'macos-latest'
              env:
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
              run: pnpm tauri build ${{ matrix.platform.args }}

            - name: Upload artifacts (macOS)
              if: matrix.platform.os == 'macos-latest'
              uses: softprops/action-gh-release@v2
              with:
                  name: "Release ${{ github.ref_name }}"
                  body: "See CHANGELOG.md for details"
                  draft: true
                  prerelease: false
                  files: |
                      src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
                      src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app.tar.gz
                      src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app.tar.gz.sig

            - name: Upload artifacts (Linux)
              if: matrix.platform.os == 'ubuntu-22.04'
              uses: softprops/action-gh-release@v2
              with:
                  name: "Release ${{ github.ref_name }}"
                  body: "See CHANGELOG.md for details"
                  draft: true
                  prerelease: false
                  files: |
                      src-tauri/target/release/bundle/appimage/*.AppImage
                      src-tauri/target/release/bundle/appimage/*.AppImage.tar.gz
                      src-tauri/target/release/bundle/appimage/*.AppImage.tar.gz.sig
                      src-tauri/target/release/bundle/deb/*.deb
                      src-tauri/target/release/bundle/rpm/*.rpm

            - name: Upload artifacts (Windows)
              if: matrix.platform.os == 'windows-latest'
              uses: softprops/action-gh-release@v2
              with:
                  name: "Release ${{ github.ref_name }}"
                  body: "See CHANGELOG.md for details"
                  draft: true
                  prerelease: false
                  files: |
                      src-tauri/target/release/bundle/nsis/*-setup.exe
                      src-tauri/target/release/bundle/nsis/*-setup.nsis.zip
                      src-tauri/target/release/bundle/nsis/*-setup.nsis.zip.sig
                      src-tauri/target/release/bundle/msi/*.msi
                      src-tauri/target/release/bundle/msi/*.msi.zip
                      src-tauri/target/release/bundle/msi/*.msi.zip.sig

    publish-release:
        name: Publish Release
        needs: build-and-release
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: lts/*

            - name: Generate and upload latest.json
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: node scripts/updater.mjs ${{ github.ref_name }}

            - name: Publish release
              uses: softprops/action-gh-release@v2
              with:
                  draft: false
                  prerelease: false
